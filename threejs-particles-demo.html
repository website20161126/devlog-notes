<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Three.js ç²’å­ç³»ç»Ÿäº¤äº’</title>
  <style>
    /* --- åŸºç¡€æ ·å¼ --- */
    body {
      margin: 0;
      overflow: hidden;
      background-color: #050505;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    canvas {
      display: block;
    }

    #input_video {
      display: none;
    }

    /* --- 1. æ¨¡æ€å¼¹çª—æ ·å¼ --- */
    #permission-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: #2a2a38;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      width: 80%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      color: #fff;
    }

    .modal-content h3 {
      margin-top: 0;
      color: #fff;
      font-size: 20px;
    }

    .modal-content p {
      color: #ccc;
      margin-bottom: 25px;
      font-size: 14px;
    }

    .modal-buttons button {
      width: 48%;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      margin: 0 2px;
      transition: background-color 0.2s;
    }

    #allow-btn {
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      border: none;
      color: white;
    }

    #allow-btn:hover {
      background: linear-gradient(135deg, #00a0d0, #005bb5);
    }

    #deny-btn {
      background: #555;
      border: none;
      color: white;
    }

    #deny-btn:hover {
      background: #777;
    }

    /* --- 2. UI é¢æ¿å’Œæ§åˆ¶æŒ‰é’®æ ·å¼ --- */
    #ui-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 260px;
      max-height: 90vh;
      overflow-y: auto;
      background: rgba(20, 20, 35, 0.85);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      transition: all 0.3s ease-out;
      z-index: 100;
    }

    .panel-hidden {
      transform: translateX(300px);
      opacity: 0;
      pointer-events: none;
    }

    h2 {
      font-size: 18px;
      margin-top: 0;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
    }

    .control-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 5px;
      color: #aaa;
    }

    button {
      background: linear-gradient(135deg, #6e8efb, #a777e3);
      border: none;
      border-radius: 6px;
      color: white;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 12px;
      width: 100%;
      margin-bottom: 5px;
      transition: all 0.2s;
      text-align: center;
    }

    button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    button.active {
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      box-shadow: 0 0 10px rgba(0, 114, 255, 0.5);
    }

    input[type="color"] {
      width: 100%;
      height: 35px;
      border: none;
      cursor: pointer;
      background: transparent;
      padding: 0;
    }

    #status {
      position: absolute;
      top: 20px;
      left: 20px;
      color: #00ff88;
      font-size: 14px;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 20px;
      pointer-events: none;
      z-index: 99;
    }

    .loading {
      color: #ffaa00 !important;
    }

    .tip {
      font-size: 11px;
      color: #666;
      margin-top: 10px;
      line-height: 1.4;
    }

    #toggle-panel-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      padding: 0;
      background: rgba(100, 100, 100, 0.7);
      border-radius: 50%;
      line-height: 40px;
      text-align: center;
      font-size: 20px;
      z-index: 101;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      transform: none !important;
    }

    .control-group-shape {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .control-group-shape button {
      flex: 1 1 45%;
      margin-bottom: 0;
    }

    /* --- 3. ç§»åŠ¨ç«¯å“åº”å¼è°ƒæ•´ --- */
    @media (max-width: 600px) {
      #ui-panel {
        top: 60px;
        right: 10px;
        width: 240px;
        padding: 15px;
      }

      #status {
        top: 10px;
        left: 10px;
        font-size: 12px;
      }

      .control-group-shape {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }

      .control-group-shape button {
        flex: 1 1 45%;
        margin-bottom: 0;
      }
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>

<body>

  <video id="input_video"></video>

  <div id="status" class="loading">æ­£åœ¨åŠ è½½é¡µé¢èµ„æº...</div>

  <button id="toggle-panel-btn" onclick="togglePanel()">âš™</button>

  <div id="ui-panel">
    <h2>ç²’å­æ§åˆ¶å°</h2>

    <div class="control-group control-group-shape">
      <label>æ¨¡å‹é€‰æ‹©</label>
      <button onclick="setShape('heart')" class="shape-btn active" id="btn-heart">â¤ï¸ çˆ±å¿ƒ</button>
      <button onclick="setShape('flower')" class="shape-btn" id="btn-flower">ğŸŒ¸ èŠ±æœµ</button>
      <button onclick="setShape('saturn')" class="shape-btn" id="btn-saturn">ğŸª åœŸæ˜Ÿ</button>
      <button onclick="setShape('buddha')" class="shape-btn" id="btn-buddha">ğŸ§˜ ä½›åƒ</button>
      <button onclick="setShape('sphere')" class="shape-btn" id="btn-sphere">ğŸ”® çƒä½“</button>
    </div>

    <div class="control-group">
      <label>ç²’å­é¢œè‰²</label>
      <input type="color" id="color-picker" value="#00ffff">
    </div>

    <div class="control-group">
      <button id="fullscreen-btn" onclick="toggleFullScreen()">â›¶ å…¨å±æ¨¡å¼</button>
    </div>

    <div class="tip">
      **æ‰‹åŠ¿æ§åˆ¶æŒ‡å—ï¼š**<br>
      - å¼ å¼€æ‰‹æŒï¼šç²’å­æ‰©æ•£/æ”¾å¤§<br>
      - æ¡ç´§æ‹³å¤´ï¼šç²’å­æ”¶ç¼©/å‡èš
    </div>
  </div>

  <div id="permission-modal">
    <div class="modal-content">
      <h3>å¯ç”¨å®æ—¶æ‰‹åŠ¿è¿½è¸ª</h3>
      <p>æœ¬åº”ç”¨éœ€è¦ä½¿ç”¨æ‚¨çš„æ‘„åƒå¤´è¿›è¡Œå®æ—¶çš„æ‰‹åŠ¿è¯†åˆ« (AI æ¨¡å‹å°†åœ¨æœ¬åœ°è¿è¡Œï¼Œè§†é¢‘æ•°æ®ä¸ä¼šè¢«ä¸Šä¼ )ã€‚</p>
      <div class="modal-buttons">
        <button id="allow-btn" onclick="handlePermission(true)">å…è®¸è®¿é—® (æ¨è)</button>
        <button id="deny-btn" onclick="handlePermission(false)">ä»…é¢„è§ˆ (ç¦ç”¨æ‰‹åŠ¿)</button>
      </div>
    </div>
  </div>

  <script>
    // --- å…¨å±€å˜é‡é…ç½® ---
    const PARTICLE_COUNT = 15000;
    const PARTICLE_SIZE = 0.08;
    let currentShape = 'heart';
    let targetPositions = [];
    let particles;
    let geometry;
    let renderer, scene, camera;
    let handFactor = 0;
    let handScale = 1.0;
    let handDiffusion = 0.0;
    let cameraEnabled = false;

    // --- æ ¸å¿ƒå¯åŠ¨é€»è¾‘ ---
    window.onload = function () {
      initThree();
      animate();

      // é»˜è®¤éšè— UI é¢æ¿ï¼ˆç§»åŠ¨ç«¯å‹å¥½ï¼‰
      if (window.innerWidth <= 600) {
        document.getElementById('ui-panel').classList.add('panel-hidden');
        document.getElementById('toggle-panel-btn').innerHTML = 'âš™';
        document.getElementById('toggle-panel-btn').style.background = 'rgba(100, 100, 100, 0.7)';
      }

      // æ˜¾ç¤ºå¼¹çª—
      document.getElementById('status').innerText = "ç­‰å¾…ç”¨æˆ·æˆæƒ...";
    };

    // --- æƒé™å¤„ç†å‡½æ•° ---
    function handlePermission (allow) {
      document.getElementById('permission-modal').style.display = 'none';

      if (allow) {
        cameraEnabled = true;
        startCameraAndHands();
      } else {
        cameraEnabled = false;
        document.getElementById('status').innerText = "æ‰‹åŠ¿è¿½è¸ªå·²ç¦ç”¨ (ä»…é¢„è§ˆ)";
        document.getElementById('status').style.color = "#ffaa00";
        document.getElementById('status').classList.remove('loading');
      }
    }

    // --- å¯åŠ¨æ‘„åƒå¤´å’Œ MediaPipe ---
    function startCameraAndHands () {
      const videoElement = document.getElementById('input_video');
      const statusDiv = document.getElementById('status');

      statusDiv.innerText = "æ­£åœ¨åˆå§‹åŒ–æ‘„åƒå¤´ä¸AIæ¨¡å‹...";
      statusDiv.style.color = "#ffaa00";
      statusDiv.classList.add('loading');

      const hands = new Hands({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }
      });

      hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      hands.onResults(onResults);

      const cameraUtils = new Camera(videoElement, {
        onFrame: async () => {
          if (cameraEnabled) {
            await hands.send({ image: videoElement });
          }
        },
        width: 640,
        height: 480
      });

      cameraUtils.start()
        .then(() => {
          console.log("Camera started");
        })
        .catch(err => {
          cameraEnabled = false;
          statusDiv.innerText = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + err + " (è¯·æ£€æŸ¥æƒé™)";
          statusDiv.style.color = "red";
          statusDiv.classList.remove('loading');
        });
    }

    // --- Three.js åˆå§‹åŒ– ---
    function initThree () {
      scene = new THREE.Scene();
      scene.fog = new THREE.FogExp2(0x050505, 0.02);
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 30;
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      document.body.appendChild(renderer.domElement);

      geometry = new THREE.BufferGeometry();
      const positions = new Float32Array(PARTICLE_COUNT * 3);
      const colors = new Float32Array(PARTICLE_COUNT * 3);
      for (let i = 0; i < PARTICLE_COUNT; i++) {
        positions[i * 3] = (Math.random() - 0.5) * 50;
        positions[i * 3 + 1] = (Math.random() - 0.5) * 50;
        positions[i * 3 + 2] = (Math.random() - 0.5) * 50;
        colors[i * 3] = 0; colors[i * 3 + 1] = 1; colors[i * 3 + 2] = 1;
      }
      geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
      const material = new THREE.PointsMaterial({
        size: PARTICLE_SIZE, vertexColors: true, blending: THREE.AdditiveBlending, depthWrite: false, transparent: true, opacity: 0.8
      });
      particles = new THREE.Points(geometry, material);
      scene.add(particles);
      generateTargetPositions('heart');
      window.addEventListener('resize', onWindowResize, false);
      document.getElementById('color-picker').addEventListener('input', (e) => {
        updateParticleColor(e.target.value);
      });
    }

    // --- æ ¸å¿ƒåŠ¨ç”»å¾ªç¯ ---
    function animate () {
      requestAnimationFrame(animate);

      const positions = particles.geometry.attributes.position.array;
      const speed = 0.08;

      let targetScale = 1.0;
      let targetSpread = 0.0;

      if (cameraEnabled) {
        if (handFactor > 0.2) {
          targetScale = 1.0 + (handFactor * 1.5);
          targetSpread = handFactor * 5.0;
        } else if (handFactor < -0.2) {
          targetScale = 1.0 + (handFactor * 0.8);
          targetSpread = 0;
        }
      } else {
        handFactor *= 0.9;
        handScale += (1.0 - handScale) * 0.1;
        handDiffusion += (0.0 - handDiffusion) * 0.1;
      }

      handScale += (targetScale - handScale) * 0.1;
      handDiffusion += (targetSpread - handDiffusion) * 0.1;

      for (let i = 0; i < PARTICLE_COUNT; i++) {
        const idx = i * 3;
        let tx = targetPositions[idx];
        let ty = targetPositions[idx + 1];
        let tz = targetPositions[idx + 2];

        tx *= handScale; ty *= handScale; tz *= handScale;

        if (handDiffusion > 0.1) {
          tx += (Math.random() - 0.5) * handDiffusion;
          ty += (Math.random() - 0.5) * handDiffusion;
          tz += (Math.random() - 0.5) * handDiffusion;
        }

        const time = Date.now() * 0.0005;
        const cosT = Math.cos(time);
        const sinT = Math.sin(time);
        const rx = tx * cosT - tz * sinT;
        const rz = tx * sinT + tz * cosT;
        tx = rx; tz = rz;

        positions[idx] += (tx - positions[idx]) * speed;
        positions[idx + 1] += (ty - positions[idx + 1]) * speed;
        positions[idx + 2] += (tz - positions[idx + 2]) * speed;
      }

      particles.geometry.attributes.position.needsUpdate = true;
      camera.lookAt(scene.position);

      renderer.render(scene, camera);
    }

    // --- MediaPipe æ‰‹åŠ¿è¯†åˆ«é€»è¾‘ ---
    function onResults (results) {
      const statusDiv = document.getElementById('status');

      if (!cameraEnabled) return;

      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        statusDiv.innerText = "å·²æ£€æµ‹åˆ°æ‰‹åŠ¿";
        statusDiv.style.color = "#00ff88";
        statusDiv.classList.remove('loading');

        const landmarks = results.multiHandLandmarks[0];
        const tips = [4, 8, 12, 16, 20];
        let avgDist = 0;
        const wrist = landmarks[0];

        tips.forEach(idx => {
          const tip = landmarks[idx];
          const d = Math.sqrt(
            Math.pow(tip.x - wrist.x, 2) +
            Math.pow(tip.y - wrist.y, 2)
          );
          avgDist += d;
        });
        avgDist /= 5;

        if (avgDist < 0.25) {
          handFactor = -1 * (1 - (avgDist / 0.25));
        } else if (avgDist > 0.35) {
          handFactor = (avgDist - 0.35) / 0.25;
        } else {
          handFactor = 0;
        }

        if (handFactor > 1.5) handFactor = 1.5;
        if (handFactor < -0.8) handFactor = -0.8;

      } else {
        statusDiv.innerText = "ç­‰å¾…æ‰‹åŠ¿...";
        statusDiv.style.color = "#aaa";
        handFactor *= 0.9;
      }
    }

    // --- å½¢çŠ¶ç”Ÿæˆå‡½æ•° ---
    function generateTargetPositions (shape) {
      targetPositions = new Float32Array(PARTICLE_COUNT * 3);
      for (let i = 0; i < PARTICLE_COUNT; i++) {
        const u = Math.random(); const v = Math.random(); const theta = 2 * Math.PI * u; const phi = Math.acos(2 * v - 1);
        let x, y, z;
        
        if (shape === 'heart') {
          const t = Math.PI - 2 * Math.PI * u; const p = Math.acos(2 * v - 1); 
          x = 16 * Math.pow(Math.sin(p), 3) * Math.cos(t) * 0.5; 
          y = (13 * Math.cos(p) - 5 * Math.cos(2 * p) - 2 * Math.cos(3 * p) - Math.cos(4 * p)) * 0.5; 
          z = 8 * Math.pow(Math.sin(p), 3) * Math.sin(t) * 0.5;
        } else if (shape === 'sphere') {
          const r = 10; 
          x = r * Math.sin(phi) * Math.cos(theta); 
          y = r * Math.sin(phi) * Math.sin(theta); 
          z = r * Math.cos(phi);
        } else if (shape === 'flower') {
          const k = 5; 
          const r = 10 * Math.cos(k * theta) * Math.sin(phi) + 5; 
          x = r * Math.sin(phi) * Math.cos(theta); 
          y = r * Math.cos(phi) * 0.6; 
          z = r * Math.sin(phi) * Math.sin(theta);
        } else if (shape === 'saturn') {
          if (i < PARTICLE_COUNT * 0.7) { 
            const r = 6; 
            x = r * Math.sin(phi) * Math.cos(theta); 
            y = r * Math.sin(phi) * Math.sin(theta); 
            z = r * Math.cos(phi); 
          } else { 
            const angle = Math.random() * Math.PI * 2; 
            const dist = 9 + Math.random() * 4; 
            x = Math.cos(angle) * dist; 
            z = Math.sin(angle) * dist; 
            y = (Math.random() - 0.5) * 0.2; 
            const tilt = Math.PI / 6; 
            const tempX = x; 
            x = x * Math.cos(tilt) - y * Math.sin(tilt); 
            y = tempX * Math.sin(tilt) + y * Math.cos(tilt); 
          }
        } else if (shape === 'buddha') {
          if (i < PARTICLE_COUNT * 0.15) { 
            const r = 2.5; const yo = 6; 
            x = r * Math.sin(phi) * Math.cos(theta); 
            y = r * Math.sin(phi) * Math.sin(theta) + yo; 
            z = r * Math.cos(phi); 
          } else if (i < PARTICLE_COUNT * 0.5) { 
            const h = 7; const rBase = 4.5; const rTop = 2.0; 
            const yy = (Math.random() - 0.5) * h; 
            const percent = (yy + h / 2) / h; 
            const rCur = rBase * (1 - percent) + rTop * percent; 
            const ang = Math.random() * Math.PI * 2; 
            x = rCur * Math.cos(ang); 
            y = yy + 1; 
            z = rCur * Math.sin(ang) * 0.8; 
          } else { 
            const side = (i % 2 === 0) ? 1 : -1; 
            let px = (Math.random() * 2 - 1); 
            let py = (Math.random() * 2 - 1); 
            let pz = (Math.random() * 2 - 1); 
            const len = Math.sqrt(px * px + py * py + pz * pz); 
            px /= len; py /= len; pz /= len; 
            x = px * 3.5 + (side * 2.5); 
            y = py * 1.2 - 3.5; 
            z = pz * 2.0 + 1.5; 
            const rot = side * 0.4; 
            const tx = x * Math.cos(rot) - z * Math.sin(rot); 
            z = x * Math.sin(rot) + z * Math.cos(rot); 
            x = tx; 
          }
        }

        targetPositions[i * 3] = x;
        targetPositions[i * 3 + 1] = y;
        targetPositions[i * 3 + 2] = z;
      }
    }

    // --- UI æ§åˆ¶å‡½æ•° ---
    function setShape (shapeName) {
      currentShape = shapeName;
      document.querySelectorAll('.shape-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('btn-' + shapeName).classList.add('active');
      generateTargetPositions(shapeName);
    }

    function updateParticleColor (hex) {
      const color = new THREE.Color(hex);
      const colors = particles.geometry.attributes.color.array;
      for (let i = 0; i < PARTICLE_COUNT; i++) {
        const vary = 0.8 + Math.random() * 0.4;
        colors[i * 3] = color.r * vary;
        colors[i * 3 + 1] = color.g * vary;
        colors[i * 3 + 2] = color.b * vary;
      }
      particles.geometry.attributes.color.needsUpdate = true;
    }

    function onWindowResize () {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function toggleFullScreen () {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
    }

    function togglePanel () {
      const panel = document.getElementById('ui-panel');
      const button = document.getElementById('toggle-panel-btn');
      if (panel.classList.contains('panel-hidden')) {
        panel.classList.remove('panel-hidden');
        button.innerHTML = 'âœ•';
        button.style.background = 'rgba(200, 50, 50, 0.7)';
      } else {
        panel.classList.add('panel-hidden');
        button.innerHTML = 'âš™';
        button.style.background = 'rgba(100, 100, 100, 0.7)';
      }
    }

  </script>
</body>

</html>