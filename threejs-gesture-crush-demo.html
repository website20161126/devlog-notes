<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ‰‹åŠ¿æç¢æ¨¡å‹ï¼šç²’å­åŒ–æ•ˆæœ Demo</title>
  <style>
    /* --- åŸºç¡€æ ·å¼ --- */
    body {
      margin: 0;
      overflow: hidden;
      background-color: #050505;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    canvas {
      display: block;
    }

    #input_video {
      display: none;
    }

    /* --- UI çŠ¶æ€å’Œæç¤º --- */
    #status-bar {
      position: absolute;
      top: 20px;
      left: 20px;
      color: #fff;
      font-size: 16px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 15px;
      border-radius: 8px;
      z-index: 100;
    }

    .hand-open {
      color: #00ff88;
    }

    .hand-closed {
      color: #ff3300;
    }

    .loading {
      color: #ffaa00;
    }

    /* æƒé™å¼¹çª— */
    #permission-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: #2a2a38;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      width: 80%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      color: #fff;
    }

    .modal-content button {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      margin-top: 20px;
      cursor: pointer;
      border: none;
      color: white;
      background: linear-gradient(135deg, #00c6ff, #0072ff);
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>

<body>
  <div id="status-bar" class="loading">æ­£åœ¨åŠ è½½èµ„æº...</div>

  <video id="input_video"></video>

  <div id="permission-modal">
    <div class="modal-content">
      <h3>æ‰‹åŠ¿æ¨¡å‹äº¤äº’ Demo</h3>
      <p>æœ¬åº”ç”¨éœ€è¦ä½¿ç”¨æ‚¨çš„æ‘„åƒå¤´è¿›è¡Œæ‰‹åŠ¿è¯†åˆ«ã€‚</p>
      <p>è¯·ä¿æŒ**å¼ å¼€æ‰‹**æ¥é‡æ„æ¨¡å‹ï¼Œ**æ…¢æ…¢æ¡æ‹³**æ¥æç¢æ¨¡å‹ï¼</p>
      <button onclick="handlePermission(true)">å…è®¸è®¿é—®å¹¶å¼€å§‹</button>
    </div>
  </div>

  <script>
    // --- å…¨å±€å˜é‡é…ç½® ---
    const MODEL_SIZE = 10;
    const DISPERSE_RANGE = 40; // ç²’å­æœ€å¤§åˆ†æ•£èŒƒå›´
    const LERP_SPEED = 0.1; // ç²’å­æ’å€¼é€Ÿåº¦
    let cameraEnabled = false;
    let handFactor = 1.0; // æ‰‹åŠ¿å› å­ï¼š1.0 (å…¨å¼€) åˆ° 0.0 (å…¨æ¡)

    let scene, camera, renderer;
    let particles;

    let targetPositions = []; // å­˜å‚¨æ¨¡å‹çš„åŸå§‹é¡¶ç‚¹ä½ç½® (Target)
    let randomPositions = []; // å­˜å‚¨ç²’å­åˆ†æ•£åçš„éšæœºä½ç½® (Dispersed)

    // --- åˆå§‹åŒ– Three.js ---
    function initThree () {
      scene = new THREE.Scene();
      scene.fog = new THREE.Fog(0x050505, 1, 100);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 25;

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      document.body.appendChild(renderer.domElement);

      scene.add(new THREE.AmbientLight(0xffffff, 0.7));

      createParticleModel();

      window.addEventListener('resize', onWindowResize, false);
    }

    // --- æ ¸å¿ƒï¼šåˆ›å»ºæ¨¡å‹å’Œç²’å­ç³»ç»Ÿ ---
    function createParticleModel () {
      // 1. å®šä¹‰è¦è¢«â€œæç¢â€çš„åŸºç¡€å‡ ä½•ä½“ (ä½¿ç”¨ä¸€ä¸ªå¤æ‚çš„ç»“æ ¸ä½“)
      const modelGeometry = new THREE.TorusKnotGeometry(4, 1.5, 200, 32);

      // 2. å°†æ¨¡å‹å‡ ä½•ä½“çš„é¡¶ç‚¹ä½ç½®æå–å‡ºæ¥
      const positionAttribute = modelGeometry.getAttribute('position');
      const particleCount = positionAttribute.count;

      // 3. åˆå§‹åŒ–ç²’å­ç³»ç»Ÿçš„ BufferGeometry
      const particleGeometry = new THREE.BufferGeometry();
      const currentPositions = new Float32Array(particleCount * 3);

      // 4. å‡†å¤‡ç›®æ ‡ä½ç½®å’Œéšæœºä½ç½®
      targetPositions = new Float32Array(particleCount * 3);
      randomPositions = new Float32Array(particleCount * 3);

      for (let i = 0; i < particleCount; i++) {
        const i3 = i * 3;

        // ç›®æ ‡ä½ç½® (æ¨¡å‹åŸå§‹é¡¶ç‚¹)
        targetPositions[i3] = positionAttribute.getX(i) * 1.5;
        targetPositions[i3 + 1] = positionAttribute.getY(i) * 1.5;
        targetPositions[i3 + 2] = positionAttribute.getZ(i) * 1.5;

        // éšæœºåˆ†æ•£ä½ç½® (ç”¨äºæç¢åç²’å­çš„æœ€ç»ˆéšæœºå»å‘)
        randomPositions[i3] = (Math.random() - 0.5) * DISPERSE_RANGE;
        randomPositions[i3 + 1] = (Math.random() - 0.5) * DISPERSE_RANGE;
        randomPositions[i3 + 2] = (Math.random() - 0.5) * DISPERSE_RANGE;

        // åˆå§‹ä½ç½®è®¾å®šä¸ºç›®æ ‡ä½ç½®
        currentPositions[i3] = targetPositions[i3];
        currentPositions[i3 + 1] = targetPositions[i3 + 1];
        currentPositions[i3 + 2] = targetPositions[i3 + 2];
      }

      particleGeometry.setAttribute('position', new THREE.BufferAttribute(currentPositions, 3));

      // 5. åˆ›å»º PointsMaterial
      const material = new THREE.PointsMaterial({
        color: 0x00ffff,
        size: 0.15,
        blending: THREE.AdditiveBlending,
        transparent: true,
        opacity: 0.8,
        depthWrite: false
      });

      particles = new THREE.Points(particleGeometry, material);
      scene.add(particles);
    }

    // --- æ ¸å¿ƒåŠ¨ç”»å¾ªç¯ ---
    function animate () {
      requestAnimationFrame(animate);

      const positions = particles.geometry.attributes.position.array;
      const particleCount = targetPositions.length / 3;

      // æç¢å› å­ (Dissolve Factor): æ¡æ‹³è¶Šç´§ï¼Œå› å­è¶Šæ¥è¿‘ 1.0 (å³è¶Šåˆ†æ•£)
      // handFactor æ˜¯ 1 (å¼€) åˆ° 0 (æ¡)ï¼Œæˆ‘ä»¬ç”¨ 1 - handFactor
      const dissolveFactor = 1.0 - handFactor;

      // LERP_AMOUNT: æ§åˆ¶æ’å€¼é€Ÿåº¦ï¼Œä½¿åˆ†è§£å’Œé‡æ„è¿‡ç¨‹å¹³æ»‘
      const lerpAmount = LERP_SPEED * 0.5;

      for (let i = 0; i < particleCount; i++) {
        const i3 = i * 3;

        // ç›®æ ‡ä½ç½® (T) å’Œåˆ†æ•£ä½ç½® (D)
        const targetX = targetPositions[i3];
        const targetY = targetPositions[i3 + 1];
        const targetZ = targetPositions[i3 + 2];

        const randomX = randomPositions[i3];
        const randomY = randomPositions[i3 + 1];
        const randomZ = randomPositions[i3 + 2];

        // --- æ’å€¼è®¡ç®— (Lerp) ---

        // desiredX æ˜¯åœ¨ T å’Œ D ä¹‹é—´ï¼Œç”± dissolveFactor å†³å®šçš„ç†æƒ³ä½ç½®
        const desiredX = targetX + (randomX - targetX) * dissolveFactor;
        const desiredY = targetY + (randomY - targetY) * dissolveFactor;
        const desiredZ = targetZ + (randomZ - targetZ) * dissolveFactor;

        // å®é™…ä½ç½®å¹³æ»‘åœ°è¶‹å‘äºç†æƒ³ä½ç½®
        positions[i3] += (desiredX - positions[i3]) * lerpAmount;
        positions[i3 + 1] += (desiredY - positions[i3 + 1]) * lerpAmount;
        positions[i3 + 2] += (desiredZ - positions[i3 + 2]) * lerpAmount;
      }

      particles.geometry.attributes.position.needsUpdate = true;

      // æ—‹è½¬æ¨¡å‹ï¼Œå¢åŠ åŠ¨æ„Ÿ
      particles.rotation.y += 0.005;
      particles.rotation.x = Math.sin(particles.rotation.y) * 0.1;

      renderer.render(scene, camera);
    }

    // --- MediaPipe æ‰‹åŠ¿å¤„ç† ---
    function onResults (results) {
      const statusDiv = document.getElementById('status-bar');

      if (!cameraEnabled) return;

      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        const wrist = landmarks[0];
        const tips = [4, 8, 12, 16, 20]; // å¤§æ‹‡æŒ‡åˆ°å°æ‹‡æŒ‡æŒ‡å°–

        // è®¡ç®—æ‰‹éƒ¨å¼€åˆåº¦
        let avgDist = 0;
        tips.forEach(idx => {
          const tip = landmarks[idx];
          // æµ‹é‡æŒ‡å°–åˆ°æ‰‹è…•çš„è·ç¦»ï¼Œä½†åªçœ‹ XY å¹³é¢
          const d = Math.sqrt(Math.pow(tip.x - wrist.x, 2) + Math.pow(tip.y - wrist.y, 2));
          avgDist += d;
        });
        avgDist /= 5;

        // å½’ä¸€åŒ–æ‰‹åŠ¿å› å­ï¼š0.1 (å…¨æ¡) åˆ° 0.5 (å…¨å¼€)
        const MIN_DIST = 0.15; // æ¡æ‹³æ—¶å¹³å‡è·ç¦» (ç»éªŒå€¼)
        const MAX_DIST = 0.45; // å¼ å¼€æ—¶å¹³å‡è·ç¦» (ç»éªŒå€¼)

        handFactor = (avgDist - MIN_DIST) / (MAX_DIST - MIN_DIST);
        handFactor = Math.min(Math.max(handFactor, 0.0), 1.0); // é™åˆ¶åœ¨ [0, 1]


        // --- UI çŠ¶æ€æ›´æ–° ---
        if (handFactor < 0.2) {
          statusDiv.innerHTML = `æ‰‹åŠ¿å› å­: ${handFactor.toFixed(2)} | **ç”¨åŠ›æç¢ä¸­...** ğŸ’¥`;
          statusDiv.className = 'hand-closed';
          particles.material.color.set(0xff0000); // æç¢æ—¶å˜çº¢
        } else if (handFactor > 0.8) {
          statusDiv.innerHTML = `æ‰‹åŠ¿å› å­: ${handFactor.toFixed(2)} | **é‡æ„æ¨¡å‹...** âœ¨`;
          statusDiv.className = 'hand-open';
          particles.material.color.set(0x00ffff); // å¼ å¼€æ—¶å˜è“
        } else {
          statusDiv.innerHTML = `æ‰‹åŠ¿å› å­: ${handFactor.toFixed(2)} | ç¼“æ…¢å˜åŒ–ä¸­...`;
          statusDiv.className = '';
          particles.material.color.set(0xffffff); // ä¸­é—´çŠ¶æ€ä¸ºç™½
        }

      } else {
        statusDiv.innerHTML = "ç­‰å¾…æ‰‹åŠ¿...";
        statusDiv.className = 'loading';
        handFactor *= 0.95; // ç¼“æ…¢å›å½’å¼ å¼€çŠ¶æ€
      }
    }

    // --- æ‘„åƒå¤´å’Œ MediaPipe å¯åŠ¨ ---
    function handlePermission (allow) {
      document.getElementById('permission-modal').style.display = 'none';

      if (allow) {
        cameraEnabled = true;
        startCameraAndHands();
      } else {
        alert("æ‚¨éœ€è¦å…è®¸æ‘„åƒå¤´æƒé™æ‰èƒ½ä½¿ç”¨æ‰‹åŠ¿äº¤äº’ã€‚");
      }
    }

    function startCameraAndHands () {
      const videoElement = document.getElementById('input_video');
      const statusDiv = document.getElementById('status-bar');

      statusDiv.innerHTML = "æ­£åœ¨åˆå§‹åŒ– AI æ¨¡å‹...";

      const hands = new Hands({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }
      });

      hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      hands.onResults(onResults);

      const cameraUtils = new Camera(videoElement, {
        onFrame: async () => {
          if (cameraEnabled) {
            await hands.send({ image: videoElement });
          }
        },
        width: 640,
        height: 480
      });

      cameraUtils.start()
        .then(() => { statusDiv.innerHTML = "AI å¯åŠ¨æˆåŠŸï¼Œè¯·é è¿‘æ‘„åƒå¤´å¹¶å¼ å¼€æ‰‹æŒ..."; })
        .catch(err => {
          cameraEnabled = false;
          statusDiv.innerHTML = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + err + " (è¯·æ£€æŸ¥ HTTPS/æƒé™)";
          statusDiv.className = 'hand-closed';
        });
    }

    function onWindowResize () {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // --- å¯åŠ¨æµç¨‹ ---
    window.onload = function () {
      initThree();
      animate();
    };

  </script>
</body>

</html>